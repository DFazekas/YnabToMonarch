<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YNAB to Monarch Money</title>
  <meta name="description" content="CSV Converter tool for migrating from YNAB to Monarch Money.">
  <link rel="stylesheet" href="https://example-styles.netlify.app/styles.css">
  <style>
    button {
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    #accountsForm {
      text-align: left;
    }

    #accountsForm div {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
    }

    #accountsForm label {
      display: flex;
      align-items: baseline;
      margin-bottom: 10px;
      gap: 10px;
      flex-grow: 1;
    }

    #accountsForm label {
      line-height: 1;
    }

    #accountsForm div input[type="checkbox"] {
      width: auto;
      height: auto;
      flex-shrink: 0;
      margin: 0;
    }

    .strikethrough {
      text-decoration: line-through;
      color: grey;
    }

    .copy-button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: baseline;
    }

    .copy-button svg {
      width: 16px;
      height: 16px;
      fill: #007bff;
      vertical-align: baseline;
    }

    .copy-button:hover svg {
      fill: #0056b3;
    }

    .collapsible {
      cursor: pointer;
      background-color: #f1f1f1;
      padding: 10px;
      border: none;
      text-align: left;
      outline: none;
      width: 100%;
      font-size: 1rem;
      font-weight: bold;
    }

    .collapsible:after {
      content: '\25BC';
      float: right;
    }

    .collapsible.active:after {
      content: '\25B2';
    }

    .content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.2s ease-out;
      padding: 0 10px;
    }

    .content.open {
      max-height: 300px;
    }

    #toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
      z-index: 1000;
    }

    #toast.show {
      opacity: 1;
    }

    .header {
      padding-bottom: 10px;
    }

    #processButton {
      margin-bottom: 5px;
    }

    .download-button {
      font-size: 12px;
      padding: 5px 10px;
      line-height: 1;
    }
  </style>
</head>

<body>
  <header>
    <div style="margin-top: 20px;">
      <a href="https://buymeacoffee.com/fazekasdevh" target="_blank">
        <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee"
          style="height: 48px; width: 173.6px;" />
      </a>
    </div>
    <h1 class="header">YNAB to Monarch Money</h1>
    <p>Effortlessly migrate your YNAB transaction records into Monarch Money</p>
  </header>
  <main>
    <section>
      <button class="collapsible">Importing Transactions into New Account</button>
      <div class="content">
        <ol>
          <li>In <a href="https://app.monarchmoney.com/" target="_blank">Monarch Money</a>, go to the Accounts tab.</li>
          <li>Click "+ Add Account" in the top-right corner.</li>
          <li>Select "Add Manual Account".</li>
          <li>Choose the appropriate account type.</li>
          <li>Copy the account name from this list into the name field in Monarch.</li>
          <li>Set the starting balance to $0.</li>
          <li>In the top-right corner of the newly created Account page, click "Edit", then choose "Upload
            transactions".</li>
          <li>Click "UPLOAD A CSV FILE", then upload the transactions file for the corresponding Account.</li>
          <li>Enable the "Adjust account's balances based on these transactions" toggle.</li>
          <li>Click "Add to account".</li>
        </ol>
      </div>
      <button class="collapsible">Importing Transactions into Existing Account</button>
      <div class="content">
        <ol>
          <li>In <a href="https://app.monarchmoney.com/" target="_blank">Monarch Money</a>, go to the Accounts tab.</li>
          <li>Click on the corresponding Account that you want to import transactions into.</li>
          <li>In the top-right corner of the Account page, click "Edit", then choose "Upload transactions".</li>
          <li>Click "UPLOAD A CSV FILE", then upload the converted transactions file for the corresponding Account.</li>
          <li>Enable the "Adjust account's balances based on these transactions" toggle.</li>
          <li>Click "Add to account".</li>
        </ol>
      </div>

      <label for="fileInput">Upload Your YNAB Register File:</label>
      <input type="file" id="fileInput" accept=".csv" aria-label="Upload YNAB Register File" />
      <button id="processButton" type="button" disabled aria-label="Generate transaction files">Generate Monarch
        Transaction Files</button>
      <div>
        <small>Your financial data is processed securely and is not stored at any point.</small>
      </div>
    </section>
    <section id="accountsSection" style="display: none; margin-top: 20px;">
      <hr />
      <h4 class="header">Accounts Found in File</h4>
      <p>Monarch doesn't support importing multiple accounts at once, so you'll need to import these account
        individually. Use the checkboxes to track your progress.</p>
      <form id="accountsForm">
        <!-- Elements added dynamically -->
      </form>
    </section>
  </main>
  <footer>
    <small>Â© 2024 Fazekas Solutions</small>
  </footer>

  <div id="toast"></div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const processButton = document.getElementById('processButton');
    const accountsSection = document.getElementById('accountsSection');
    const accountsForm = document.getElementById('accountsForm');
    const toast = document.getElementById('toast');

    fileInput.addEventListener('change', async () => {
      const file = fileInput.files[0]
      // 2MB limit
      if (file && file.size > 2 * 1024 * 1024) {
        showToast('Uploaded file is too large (greater than 2MB).', true)
        fileInput = ''
        return;
      }

      if (file && file.type !== 'text/csv') {
        showToast('Only CSV files are allowed.', true)
        fileInput = ''
        return;
      }

      processButton.disabled = !fileInput.files.length;
    });

    processButton.addEventListener('click', async () => {
      const file = fileInput.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('file', file);

      try {
        const response = await fetch(
          // 'https://ynab-to-monarch.netlify.app/.netlify/functions/convertFile'
          'http://localhost:8888/.netlify/functions/convertFile'
          , {
            method: 'POST',
            body: formData,
          });

        if (!response.ok) {
          throw new Error(`Error: ${response.statusText}`);
        }

        const { files } = await response.json();
        accountsForm.innerHTML = ''; // Clear previous results
        accountsSection.style.display = 'block';

        files.forEach(({ account, filename, content }) => {
          const label = document.createElement('label');

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.addEventListener('change', (e) => {
            if (e.target.checked) {
              accountName.classList.add('strikethrough');
            } else {
              accountName.classList.remove('strikethrough');
            }
          });

          const accountContainer = document.createElement('div');
          const accountName = document.createElement('span');
          accountName.textContent = account;

          label.appendChild(checkbox)
          label.appendChild(accountName)

          const copyButton = document.createElement('span');
          copyButton.className = 'copy-button';
          copyButton.title = 'Copy account name to clipboard';
          copyButton.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M16 1H4a2 2 0 0 0-2 2v14h2V3h12V1zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 16H8V7h11v14z"></path>
              </svg>
            `;
          copyButton.addEventListener('click', () => {
            navigator.clipboard.writeText(accountName.innerText);
            showToast(`Copied "${accountName.innerText}" to clipboard.`);
          });

          const downloadButton = document.createElement('button');
          downloadButton.textContent = 'Download';
          downloadButton.className = 'download-button';
          downloadButton.type = "button";
          downloadButton.title = 'Download account transactions';
          downloadButton.addEventListener('click', () => {
            const blob = new Blob([content], { type: 'text/csv' });
            const downloadUrl = window.URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast(`Downloaded "${filename}"`);
          });

          accountContainer.appendChild(label);
          accountContainer.appendChild(copyButton);
          accountContainer.appendChild(downloadButton);

          accountsForm.appendChild(accountContainer);
        });
      } catch (error) {
        console.error('Error processing file:', error);

        showToast('An error occurred while processing the file.', true)
      }
    });

    // Toast Notification
    function showToast(message, isError = false) {
      toast.textContent = message;
      toast.style.backgroundColor = isError ? '#d9534f' : '#333'
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 4000);
    }

    // Collapsible Instructions
    document.querySelectorAll('.collapsible').forEach((button) => {
      button.addEventListener('click', () => {
        const content = button.nextElementSibling;
        content.classList.toggle('open');
        button.classList.toggle('active');
      });
    });
  </script>
</body>

</html>