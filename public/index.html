<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YNAB to Monarch Money</title>
  <meta name="description" content="CSV Converter tool for migrating from YNAB to Monarch Money.">
  <link rel="stylesheet" href="https://example-styles.netlify.app/styles.css">
  <style>
    button {
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    #accountsForm {
      text-align: left;
    }

    #accountsForm div {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
    }

    #accountsForm label {
      display: flex;
      align-items: baseline;
      margin-bottom: 10px;
      gap: 10px;
      flex-grow: 1;
    }

    #accountsForm label {
      line-height: 1;
    }

    #accountsForm div input[type="checkbox"] {
      width: auto;
      height: auto;
      flex-shrink: 0;
      margin: 0;
    }

    .strikethrough {
      text-decoration: line-through;
      color: grey;
    }

    .copy-button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: baseline;
    }

    .copy-button svg {
      width: 16px;
      height: 16px;
      fill: #007bff;
      vertical-align: baseline;
    }

    .copy-button:hover svg {
      fill: #0056b3;
    }

    .collapsible {
      cursor: pointer;
      background-color: #f1f1f1;
      padding: 10px;
      border: none;
      text-align: left;
      outline: none;
      width: 100%;
      font-size: 1rem;
      font-weight: bold;
    }

    .collapsible:after {
      content: '\25BC';
      float: right;
    }

    .collapsible.active:after {
      content: '\25B2';
    }

    .content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.2s ease-out;
      padding: 0 10px;
    }

    .content.open {
      max-height: 300px;
    }

    #toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
      z-index: 1000;
    }

    #toast.show {
      opacity: 1;
    }

    .header {
      padding-bottom: 10px;
    }

    #processButton {
      margin-bottom: 5px;
    }

    .download-button {
      font-size: 12px;
      padding: 5px 10px;
      line-height: 1;
    }

    /* Spinner */
    #loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Disable pointer events for the body when processing */
    body.processing {
      pointer-events: none;
      user-select: none;
    }
  </style>
</head>

<body>
  <!-- Loader spinner -->
  <div id="loader" style="display: none;">
    <div class="spinner"></div>
  </div>

  <!-- Header -->
  <header>
    <div style="margin-top: 20px;">
      <a href="https://buymeacoffee.com/fazekasdevh" target="_blank">
        <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee"
          style="height: 48px; width: 173.6px;" />
      </a>
    </div>
    <h1 class="header">Migrate YNAB to Monarch Money</h1>
    <p>Effortlessly migrate your YNAB transaction records into Monarch Money</p>
  </header>

  <main>
    <section>
      <!-- File importer -->
      <span>
        <label for="fileInput">Upload Your YNAB Register File:</label>
        <input type="file" id="fileInput" accept=".csv" aria-label="Upload YNAB Register File" />
        <button id="processButton" type="button" disabled aria-label="Generate downloadable transaction files">Convert
          to
          Monarch format</button>
        <div id="convertedFiles"></div>
      </span>

      <!-- Divider -->
      <div style="margin-top: 20px;">
        <div style="display: flex; align-items: center; justify-content: center; margin: 20px 0;">
          <hr style="flex-grow: 1; border: none; border-top: 1px solid #ccc; margin: 0 10px;">
          <div>Optional: Automated Importer</div>
          <hr style="flex-grow: 1; border: none; border-top: 1px solid #ccc; margin: 0 10px;">
        </div>
      </div>

      <!-- Monarch login -->
      <form>
        <div>Enter your Monarch credentials to pull your Accounts and automatically import the transactions into
          Monarch:
        </div>
        <div style="display: flex; gap: 20px; align-items: flex-start; margin-top: 10px;">
          <div style="flex: 1;">
            <label for="email">Monarch Email:</label>
            <input type="email" id="email" aria-label="Email" placeholder="Enter your Monarch email" required
              style="width: 100%;" />
          </div>
          <div style="flex: 1;">
            <label for="password">Monarch Password:</label>
            <input type="password" id="password" aria-label="Password" placeholder="Enter your Monarch password"
              required style="width: 100%;" />
          </div>
        </div>
        <button id="loginButton" type="button" disabled aria-label="Login" style="margin-top: 10px;">Pull Accounts from
          Monarch</button>
      </form>

      <!-- Security note -->
      <div>
        <small style="align-items: baseline;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16"
            style="vertical-align: middle; fill: white;">
            <path
              d="M12 2C9.243 2 7 4.243 7 7v3H5v12h14V10h-2V7c0-2.757-2.243-5-5-5zm0 2c1.654 0 3 1.346 3 3v3H9V7c0-1.654 1.346-3 3-3zm-5 8h10v10H7V12z" />
          </svg>
          Your financial data is processed securely and is not stored at any point.
        </small>
      </div>
    </section>

    <!-- Accounts container -->
    <section id="accountsSection" style="display: none; margin-top: 20px;">
      <hr />
      <h4 class="header">Accounts Found in File</h4>
      <p>Monarch doesn't support importing multiple accounts at once, so you'll need to import these account
        individually. Use the checkboxes to track your progress.</p>
      <form id="accountsForm">
        <!-- Elements added dynamically -->
      </form>
    </section>
  </main>

  <!-- Footer -->
  <footer>
    <small>Â© 2024 Fazekas Solutions</small>
  </footer>

  <!-- Toast -->
  <div id="toast"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script>
    const fileInput = document.getElementById('fileInput');
    const processButton = document.getElementById('processButton');
    const toast = document.getElementById('toast');
    const emailInput = document.getElementById("email")
    const passwordInput = document.getElementById("password")
    const loginButton = document.getElementById("loginButton")

    const accountsFromMonarch = {}

    fileInput.addEventListener('change', async () => {
      const file = fileInput.files[0]
      // 2MB limit
      if (file && file.size > 2 * 1024 * 1024) {
        showToast('Uploaded file is too large (greater than 2MB).', true)
        fileInput = ''
        return;
      }

      if (file && file.type !== 'text/csv') {
        showToast('Only CSV files are allowed.', true)
        fileInput = ''
        return;
      }

      processButton.disabled = !fileInput.files.length;
    });

    emailInput.addEventListener('input', () => {
      loginButton.disabled = !(emailInput.value && passwordInput.value);
    });

    passwordInput.addEventListener('input', () => {
      loginButton.disabled = !(emailInput.value && passwordInput.value);
    });

    processButton.addEventListener('click', async () => {
      const file = fileInput.files[0];
      if (!file) return;

      // Show the loader
      const startTime = Date.now();
      showLoader();

      try {
        // Read the CSV file
        const reader = new FileReader()
        reader.onload = (event) => {
          const csvContent = event.target.result

          // Parse CSV using PapaParse
          Papa.parse(csvContent, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
              const data = results.data
              processCSVData(data)

              // Hide the loader after processing
              hideLoader(startTime)
            },
            error: (error) => {
              console.error("Error parsing CSV:", error)
              showToast('An error occurred while processing the CSV file.', true)

              // Hide the loader on error
              hideLoader(startTime)
            }
          })
        }

        reader.readAsText(file)
      } catch (error) {
        console.error('Error during file processing:', error);
        showToast('An error occurred during file processing.', true);

        // Hide the loader on exception
        hideLoader(startTime);
      }
    })

    function processCSVData(data) {
      // Group transactions by account
      const transactionsByAccount = {}

      data.forEach((row) => {
        const account = row.Account?.trim()
        if (!account) return

        if (!transactionsByAccount[account]) {
          transactionsByAccount[account] = []
        }

        transactionsByAccount[account].push({
          Date: row.Date,
          Merchant: row.Payee || '',
          Category: row.Category,
          Account: row.Account,
          'Original Statement': '',
          Notes: row.Memo || '',
          Amount:
            parseFloat((row.Inflow || '0').replace(/[$,]/g, '')) -
            parseFloat((row.Outflow || '0').replace(/[$,]/g, '')),
          Tags: row.Flag || '',
        })
      })

      console.table(transactionsByAccount)
      // Generate downloadable CSV files for each account
      generateDownloadableFiles(transactionsByAccount)
    }

    function generateDownloadableFiles(transactionsByAccount) {
      const convertedFiles = document.getElementById('convertedFiles');
      convertedFiles.innerHTML = '<h3>Converted Account Files:</h3>';
      Object.keys(transactionsByAccount).forEach((account) => {
        const csvData = transactionsByAccount[account];
        const csvContent = Papa.unparse(csvData);

        // Create a downloadable link
        const fileName = `${account}_transactions.csv`;
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const downloadUrl = URL.createObjectURL(blob);

        const downloadLink = document.createElement('a');
        downloadLink.href = downloadUrl;
        downloadLink.download = fileName;
        downloadLink.textContent = fileName;
        downloadLink.style.display = 'block';

        convertedFiles.appendChild(downloadLink);
      });

      showToast('Conversion complete! Download your files below.');
    }

    // Toast Notification
    function showToast(message, isError = false) {
      toast.textContent = message;
      toast.style.backgroundColor = isError ? '#d9534f' : '#333'
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 4000);
    }

    // Collapsible Instructions
    // document.querySelectorAll('.collapsible').forEach((button) => {
    //   button.addEventListener('click', () => {
    //     const content = button.nextElementSibling;
    //     content.classList.toggle('open');
    //     button.classList.toggle('active');
    //   });
    // });

    // Log into Monarch and get accounts
    loginButton.addEventListener('click', async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      if (!email || !password) {
        showToast('Please enter both email and password.', true);
        return;
      }

      try {
        const accounts = await loginAndFetchAccounts(email, password)
        displayAccounts(accounts)
      } catch (error) {
        console.error('Error during login:', error);
        showToast('An error occurred during login.', true);
      }
    });

    async function loginAndFetchAccounts(username, password) {
      try {
        // Login request
        const loginResponse = await fetch('https://api.monarchmoney.com/auth/login/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: username,
            password: password
          })
        });

        if (!loginResponse.ok) {
          throw new Error('Login failed. Check your credentials.');
        }

        const loginData = await loginResponse.json();
        const token = loginData.token;

        const accounts = await fetchAccounts(token)
        return accounts
      } catch (error) {
        console.error('Error:', error)
        throw new Error(error.message);
      }
    }

    async function fetchAccounts(token) {
      const graphqlResponse = await fetch('https://api.monarchmoney.com/graphql', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Token ${token}`,
        },
        body: JSON.stringify({ query: 'query { accounts { id displayName } }' }),
      });

      if (!graphqlResponse.ok) {
        throw new Error('Failed to fetch accounts.');
      }

      const graphqlData = await graphqlResponse.json();
      return graphqlData.data.accounts;
    }

    function displayAccounts(accounts) {
      const accountsContainer = document.getElementById('accountsContainer');
      accountsContainer.innerHTML = '<h3>Your Accounts:</h3>';

      accounts.forEach(account => {
        const accountDiv = document.createElement('div');
        accountDiv.textContent = account.displayName
        accountDiv.classList.add('account');

        accountsContainer.appendChild(accountDiv);
      });
    }

    // Loader
    function showLoader() {
      document.getElementById('loader').style.display = 'flex'
      document.body.classList.add('processing')
    }

    function hideLoader(startTime) {
      const elapsedTime = Date.now() - startTime;
      const remainingTime = Math.max(0, 3000 - elapsedTime); // Ensure 3 seconds minimum

      setTimeout(() => {
        document.getElementById('loader').style.display = 'none';
        document.body.classList.remove('processing');
      }, remainingTime);
    }
  </script>
</body>

</html>