<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YNAB to Monarch Money</title>
  <meta name="description" content="CSV Converter tool for migrating from YNAB to Monarch Money.">
  <link rel="stylesheet" href="https://example-styles.netlify.app/styles.css">
  <style>
    button {
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    #accountsForm {
      text-align: left;
    }

    #accountsForm div {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
    }

    #accountsForm label {
      display: flex;
      align-items: baseline;
      margin-bottom: 10px;
      gap: 10px;
      flex-grow: 1;
    }

    #accountsForm label {
      line-height: 1;
    }

    #accountsForm div input[type="checkbox"] {
      width: auto;
      height: auto;
      flex-shrink: 0;
      margin: 0;
    }

    .strikethrough {
      text-decoration: line-through;
      color: grey;
    }

    .copy-button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: baseline;
    }

    .copy-button svg {
      width: 16px;
      height: 16px;
      fill: #007bff;
      vertical-align: baseline;
    }

    .copy-button:hover svg {
      fill: #0056b3;
    }

    .collapsible {
      cursor: pointer;
      padding: 12px 16px;
      border-radius: 4px;
      background-color: #f9f9f9;
      font-size: 1rem;
      font-weight: bold;
      color: #333;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .collapsible:hover {
      background-color: #f1f1f1;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .collapsible:after {
      content: '\25BC';
      /* Down arrow */
      font-size: 1.2rem;
      color: #333;
      transition: transform 0.3s ease;
    }

    .collapsible.active:after {
      transform: rotate(180deg);
    }

    .collapsible.active {
      background-color: #e6f7ff;
      border-color: #007bff;
      color: #007bff;
    }

    .content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
      padding: 0 16px;
      border-top: none;
      border-radius: 0 0 4px 4px;
      background-color: #fff;
      margin-bottom: 3px;
    }

    .content.open {
      padding: 12px 16px;
    }

    .content p,
    .content ol,
    .content ul {
      margin: 0;
      padding: 0;
      color: #555;
      line-height: 1.6;
    }

    .content ul,
    .content ol {
      padding-left: 20px;
    }

    #toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
      z-index: 1000;
    }

    #toast.show {
      opacity: 1;
    }

    .header {
      padding-bottom: 10px;
    }

    #processButton {
      margin-bottom: 5px;
    }

    .download-button {
      font-size: 12px;
      padding: 5px 10px;
      line-height: 1;
    }

    /* Spinner */
    #loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Disable pointer events for the body when processing */
    body.processing {
      pointer-events: none;
      user-select: none;
    }
  </style>
</head>

<body>
  <!-- Loader spinner -->
  <div id="loader" style="display: none;">
    <div class="spinner"></div>
  </div>

  <!-- Header -->
  <header>
    <div style="margin-top: 20px;">
      <a href="https://buymeacoffee.com/fazekasdevh" target="_blank">
        <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee"
          style="height: 48px; width: 173.6px;" />
      </a>
    </div>
    <h1 class="header">Migrate YNAB to Monarch Money</h1>
    <p>Effortlessly migrate your YNAB transaction records into Monarch Money</p>
  </header>

  <main>
    <section>
      <form>
        <span>
          <label for="fileInput">Upload Your YNAB Register File:</label>
          <input type="file" id="fileInput" accept=".csv" aria-label="Upload YNAB Register File" />
        </span>
        <div>(Optional) For auto-importing transactions into Monarch, enter your Monarch credentials to pull your
          Accounts and map the accounts between YNAB and Monarch:
        </div>

        <!-- Login fields -->
        <div style="display: flex; gap: 20px; align-items: flex-start; margin-top: 10px;">
          <!-- Email field -->
          <div style="flex: 1;">
            <label for="email">Monarch Email:</label>
            <input type="email" id="email" aria-label="Email" placeholder="Enter your Monarch email" required
              style="width: 100%;" />
          </div>

          <!-- Password field -->
          <div style="flex: 1;">
            <label for="password">Monarch Password:</label>
            <input type="password" id="password" aria-label="Password" placeholder="Enter your Monarch password"
              required style="width: 100%;" />
          </div>
        </div>

        <button id="processButton" type="button" disabled aria-label="Generate downloadable transaction files">(Manual)
          Generate Downloadable Files</button>
        <button id="loginButton" type="button" disabled aria-label="Login" style="margin-top: 10px;">(Auto) Generate
          Account Mappings</button>
      </form>

      <!-- Security note -->
      <div>
        <hr />
        <small style="align-items: baseline;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16"
            style="vertical-align: middle; fill: white;">
            <path
              d="M12 2C9.243 2 7 4.243 7 7v3H5v12h14V10h-2V7c0-2.757-2.243-5-5-5zm0 2c1.654 0 3 1.346 3 3v3H9V7c0-1.654 1.346-3 3-3zm-5 8h10v10H7V12z" />
          </svg>
          Your financial data is processed securely and is not stored at any point.
        </small>
      </div>
    </section>

    <!-- Mappings container -->
    <section id="mappingsContainer">
      <h4 class="header">Account Mappings</h4>
      <p>Choose how to import your YNAB transactions into Monarch:</p>
      <span id="accountMappingsContainer">
        <!-- Elements added dynamically -->
      </span>
      <button id="processMappingsButton" type="button" style="margin-top: 20px;">Import into Monarch</button>
    </section>

    <!-- File accounts container -->
    <section id="fileAccountsContainer">
      <h4 class="header">Accounts Found in File</h4>
      <p>Monarch doesn't support importing multiple accounts at once, so you'll need to import these accounts
        individually:</p>
      <form id="convertedFiles">
        <!-- Elements added dynamically -->
      </form>
    </section>

    <!-- Logs container -->
    <section>
      <h4>Logs</h4>
      <span id="logsContainer">
        <!-- Elements added dynamically -->
      </span>
    </section>
  </main>

  <!-- Footer -->
  <footer>
    <small>© 2024 Fazekas Solutions</small>
  </footer>

  <!-- Toast -->
  <div id="toast"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script>
    const fileInput = document.getElementById('fileInput');
    const processButton = document.getElementById('processButton');
    const toast = document.getElementById('toast');
    const emailInput = document.getElementById("email")
    const passwordInput = document.getElementById("password")
    const loginButton = document.getElementById("loginButton")
    const processMappingButton = document.getElementById('processMappingsButton')
    const logsContainer = document.getElementById('logsContainer')

    let allLogs = []
    let accountsFromFile = {}
    const accountsFromMonarch = {}

    processMappingButton.addEventListener('click', async () => {
      const logTitle = "Import accounts into Monarch"
      const logs = ["Attempting import account mappings into Monarch..."]

      const mappings = [];
      const omittedAccounts = [];

      const accountMappingsContainer = document.getElementById('accountMappingsContainer')
      console.table({ accountMappingsContainer })
      console.table({ children: accountMappingsContainer.children })
      Array.from(accountMappingsContainer.children).forEach(divElement => {
        const selectElement = divElement.children[1]
        const ynabAccount = selectElement.id
        const destination = selectElement.selectedOption

        if (destination === "new") {
          // Create a new account in Monarch before importing transactions
          const mappedValue = ""
          mappings.push({ ynabAccount, mappedValue })
        } else if (destination === true) {
          // Import transactions into existing account
          const mappedValue = ""
          mappings.push({ ynabAccount, mappedValue })
        } else {
          // Do not import these transactions into Monarch
          omittedAccounts.push(ynabAccount)
        }
      })

      // Show confirmation dialog
      const confirmationMessage = omittedAccounts.length
        ? `You're omitting ${omittedAccounts.length} accounts for importing. This action is irreversible.`
        : `You're about to process the account mappings. This action is irreversible.`

      if (!confirm(confirmationMessage)) {
        return
      }

      const startTime = Date.now()
      showLoader()

      try {
        const response = await fetch(
          'http://localhost:8888/.netlify/functions/MonarchMapAccounts',
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mappings })
          }
        )

        if (!response.ok) {
          throw new Error('Importing accounts into Monarch failed.')
        }

        logs.push("Importing accounts into Monarch successful.")

        const result = await response.json()
        showToast('Mappings processed successfully.')
      } catch (error) {
        allLogs.push({
          title: logTitle,
          status: "Failed",
          logs: [error.message || 'An error occurred during file processing.']
        });
      } finally {
        hideLoader(startTime)
        displayLogs(allLogs)
      }
    })

    fileInput.addEventListener('change', async () => {
      const file = fileInput.files[0]
      // 2MB limit
      if (file && file.size > 2 * 1024 * 1024) {
        showToast('Uploaded file is too large (greater than 2MB).', true)
        fileInput = ''
        return;
      }

      if (file && file.type !== 'text/csv') {
        showToast('Only CSV files are allowed.', true)
        fileInput = ''
        return;
      }

      processButton.disabled = !fileInput.files.length;

      loginButton.disabled = !(fileInput.files.length && emailInput.value && passwordInput.value)
    });

    emailInput.addEventListener('input', () => {
      loginButton.disabled = !(fileInput.files.length && emailInput.value && passwordInput.value)
    });

    passwordInput.addEventListener('input', () => {
      loginButton.disabled = !(fileInput.files.length && emailInput.value && passwordInput.value)
    });

    processButton.addEventListener('click', async () => {
      const startTime = Date.now()

      allLogs = [] // Clear previous logs

      try {
        const file = fileInput.files[0]
        if (!file) {
          showToast('Please upload a YNAB Register file.', true)
          allLogs.push({
            title: "File Processing",
            status: "Failed",
            logs: ['No file uploaded.']
          });
          displayLogs(allLogs);
          return
        }

        const { accounts: accountsFromFile, logs: fileLogs } = await processFile(file)
        if (!accountsFromFile) {
          allLogs.push(fileLogs)
          throw new Error('Processing YNAB Register file failed.')
        }

        allLogs.push(fileLogs)

        generateDownloadableFiles(accountsFromFile)
      } catch (error) {
        console.error('Error:', error);
        if (error.logs) {
          allLogs.push(error.logs);
        } else {
          allLogs.push({
            title: "File Processing",
            status: "Failed",
            logs: [error.message || 'An error occurred during file processing.']
          });
        }
      } finally {
        hideLoader(startTime)
        displayLogs(allLogs)
      }
    })

    function displayLogs(logs) {
      console.table(logs)

      logsContainer.innerHTML = '';

      logs.forEach(sectionLog => {
        const collapsibleDiv = document.createElement('div')
        collapsibleDiv.classList.add('collapsible')

        const titleContainer = document.createElement('span')

        const statusElement = document.createElement('span')
        statusElement.style.color = sectionLog.status === "Success" ? "green" : "red"
        statusElement.innerHTML = sectionLog.status === "Success" ? "✔" : "✖"

        const titleElement = document.createElement('span')
        titleElement.innerHTML = `${sectionLog.status}: ${sectionLog.title}`

        titleContainer.appendChild(statusElement)
        titleContainer.appendChild(titleElement)

        collapsibleDiv.appendChild(titleContainer)

        // Create content div
        const contentDiv = document.createElement('div');
        contentDiv.classList.add('content');

        const ol = document.createElement('ol');
        sectionLog.logs.forEach(logMessage => {
          const li = document.createElement('li');
          li.textContent = logMessage;
          ol.appendChild(li);
        });

        contentDiv.appendChild(ol);

        // Append to logs container
        logsContainer.appendChild(collapsibleDiv);
        logsContainer.appendChild(contentDiv);
      })

      initializeCollapsible();
    }

    function processFile(file) {
      const logTitle = "Processing YNAB Register file"
      const logs = ["Attempting to process YNAB Register file..."]

      return new Promise((resolve, reject) => {
        const startTime = Date.now();

        try {
          const reader = new FileReader()
          reader.onload = (event) => {
            const csvContent = event.target.result

            // Parse CSV using PapaParse
            Papa.parse(csvContent, {
              header: true,
              skipEmptyLines: true,
              complete: (results) => {
                logs.push("File imported successfully.")
                const data = results.data
                logs.push("Grouping transactions by accounts...")
                const accounts = groupTransactionsByAccount(data)
                logs.push("Grouping transactions complete.")
                // Hide the loader after processing
                hideLoader(startTime)
                resolve({ accounts, logs: { title: logTitle, status: "Success", logs } })
              },
              error: (error) => {
                logs.push("Error processing YNAB Register file.")
                console.error("Error parsing CSV:", error)
                showToast('An error occurred while processing the CSV file.', true)

                // Hide the loader on error
                hideLoader(startTime)

                const err = new Error("Error processing YNAB Register file.");
                err.logs = { title: logTitle, status: "Failed", logs };
                reject(err);
              }
            })
          }

          reader.readAsText(file)
        } catch (error) {
          logs.push("Error processing YNAB Register file.");
          console.error('Error during file processing:', error);
          showToast('An error occurred during file processing.', true);

          // Hide the loader on exception
          hideLoader(startTime);

          const err = new Error("Error processing YNAB Register file.");
          err.logs = { title: logTitle, status: "Failed", logs };
          reject(err);
        }
      })
    }

    function groupTransactionsByAccount(data) {
      // Group transactions by account
      const transactionsByAccount = {}

      data.forEach((row) => {
        const account = row.Account?.trim()
        if (!account) return

        if (!transactionsByAccount[account]) {
          transactionsByAccount[account] = []
        }

        transactionsByAccount[account].push({
          Date: row.Date,
          Merchant: row.Payee || '',
          Category: row.Category,
          Account: row.Account,
          'Original Statement': '',
          Notes: row.Memo || '',
          Amount:
            parseFloat((row.Inflow || '0').replace(/[$,]/g, '')) -
            parseFloat((row.Outflow || '0').replace(/[$,]/g, '')),
          Tags: row.Flag || '',
        })
      })

      return transactionsByAccount
    }

    function generateDownloadableFiles(transactionsByAccount) {
      const convertedFiles = document.getElementById('convertedFiles');
      Object.keys(transactionsByAccount).forEach((account) => {
        const csvData = transactionsByAccount[account];
        const csvContent = Papa.unparse(csvData);

        // Create a downloadable link
        const fileName = `${account}_transactions.csv`;
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const downloadUrl = URL.createObjectURL(blob);

        const downloadLink = document.createElement('a');
        downloadLink.href = downloadUrl;
        downloadLink.download = fileName;
        downloadLink.textContent = fileName;
        downloadLink.style.display = 'block';

        convertedFiles.appendChild(downloadLink);
      });

      showToast('Conversion complete! Download your files below.');
    }

    // Toast Notification
    function showToast(message, isError = false) {
      toast.textContent = message;
      toast.style.backgroundColor = isError ? '#d9534f' : '#333'
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 4000);
    }

    function initializeCollapsible() {
      const collapsibleElements = document.querySelectorAll('.collapsible')

      collapsibleElements.forEach(collapsible => {
        collapsible.addEventListener('click', () => {
          const content = collapsible.nextElementSibling

          collapsible.classList.toggle('active')

          if (content.classList.contains('open')) {
            content.style.maxHeight = null
            content.classList.remove('open')
          } else {
            content.style.maxHeight = `${content.scrollHeight + 20}px`;
            content.classList.add('open')
          }
        })
      })
    }
    initializeCollapsible()

    // Log into Monarch and get accounts
    loginButton.addEventListener('click', async () => {
      console.log("Login button clicked")
      allLogs = []

      const file = fileInput.files[0]
      if (!file) {
        showToast('Please upload a YNAB Register file.', true)
        allLogs.push({
          title: "Monarch Authentication",
          status: "Failed",
          logs: ['No file uploaded.']
        });
        displayLogs(allLogs);
        return;
      }

      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      if (!email || !password) {
        showToast('Please enter both email and password.', true);
        allLogs.push({
          title: "Monarch Authentication",
          status: "Failed",
          logs: ['Email or password not provided.']
        });
        displayLogs(allLogs);
        return;
      }

      const startTime = Date.now();
      showLoader();

      try {
        console.log("GetMonarchToken:")
        const { token, logs: authLogs } = await getMonarchToken(email, password)
        console.table({ authLogs })
        allLogs.push(authLogs)

        if (!token) {
          throw new Error("Monarch authentication failed.")
        }

        console.log("ProcessFile():")
        const { accounts: ynabAccounts, logs: fileLogs } = await processFile(file)
        console.table({ fileLogs })
        allLogs.push(fileLogs)

        if (!ynabAccounts) {
          allLogs.push(fileLogs)
          throw new Error('Processing YNAB Register file failed.')
        }

        console.log("FetchAccounts():")
        const { accounts: monarchAccounts, logs: fetchAccountLogs } = await fetchAccounts(token)
        allLogs.push(fetchAccountLogs)
        console.table({ fetchAccountLogs })
        console.table({ monarchAccounts })

        hideLoader(startTime)
        const { logs: mappingLogs } = displayAccountMappings(monarchAccounts, ynabAccounts)
        console.table({ mappingLogs })
        allLogs.push(mappingLogs)

      } catch (error) {
        console.error('Error:', error);
        showToast('An error occurred.', true);
      }
      finally {
        hideLoader(startTime)
        displayLogs(allLogs)
      }
    });

    async function getMonarchToken(email, password) {
      const logTitle = "Monarch authentication"
      const logs = ["Attempting to log into Monarch..."]

      try {
        const loginResponse = await fetch(
          // 'https://ynab-to-monarch.netlify.app/.netlify/functions/MonarchLogin'
          'http://localhost:8888/.netlify/functions/MonarchLogin'
          , {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email, password }),
          });

        if (!loginResponse.ok) {
          logs.push("Login failed.")
          return { token: null, logs: { title: logTitle, status: "Failed", logs } }
        }

        logs.push("Login successful.")
        const loginData = await loginResponse.json();
        const token = loginData.token;
        logs.push("Acquired user token.")

        return { token, logs: { title: logTitle, status: "Success", logs } }
      } catch (error) {
        logs.push("An error occurred during authentication.");
        console.error('Authentication Error:', error);
        return { token: null, logs: { title: logTitle, status: "Failed", logs } };
      }
    }

    async function fetchAccounts(token) {
      const logTitle = "Fetch Monarch Accounts"
      const logs = ["Attempting to fetch accounts from Monarch..."]

      try {
        const accountsResponse = await fetch(
          // 'https://ynab-to-monarch.netlify.app/.netlify/functions/MonarchLogin'
          'http://localhost:8888/.netlify/functions/MonarchAccounts'
          , {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ token }),
          });

        if (!accountsResponse.ok) {
          logs.push("Account fetching failed.")
          return { accounts: null, logs: { title: logTitle, status: "Failed", logs } }
        }

        logs.push("Account fetching successful.")
        const data = await accountsResponse.json();
        const accounts = data.accounts

        return { accounts, logs: { title: logTitle, status: "Success", logs } }
      } catch (error) {
        logs.push("An error occurred while fetching Monarch Accounts.");
        console.error('Account fetching error:', error);
        return { accounts: null, logs: { title: logTitle, status: "Failed", logs } };
      }
    }

    function displayAccountMappings(monarchAccounts, ynabAccounts) {
      const logTitle = "Generating account mappings"
      const logs = ["Attempting to generate account mappings..."]
      const accountMappingsContainer = document.getElementById('accountMappingsContainer');

      Object.keys(ynabAccounts).forEach(ynabAccount => {
        const accountDiv = document.createElement('div');
        accountDiv.classList.add('account');

        const accountLabel = document.createElement('label');
        accountLabel.textContent = ynabAccount;
        accountLabel.htmlFor = `ynab-${ynabAccount}`;

        const accountSelect = document.createElement('select');
        accountSelect.id = `${ynabAccount}`;
        accountSelect.name = `${ynabAccount}`;

        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = "Don't import";
        accountSelect.appendChild(defaultOption);

        // Option for creating new account in Monarch
        const optionCreateNewAccount = document.createElement('option')
        optionCreateNewAccount.value = "new"
        optionCreateNewAccount.textContent = "Create new account"
        accountSelect.appendChild(optionCreateNewAccount)

        // List Monarch accounts as options
        monarchAccounts.forEach(monarchAccount => {
          const option = document.createElement('option');
          option.value = monarchAccount.id;
          option.textContent = monarchAccount.displayName;
          accountSelect.appendChild(option);
        });

        accountDiv.appendChild(accountLabel);
        accountDiv.appendChild(accountSelect);
        accountMappingsContainer.appendChild(accountDiv);
      })

      logs.push("Generating account mapping successful.")
      return { logs: { title: logTitle, status: "Success", logs } }
    }

    // Loader
    function showLoader() {
      document.getElementById('loader').style.display = 'flex'
      document.body.classList.add('processing')
    }

    function hideLoader(startTime) {
      const elapsedTime = Date.now() - startTime;
      const remainingTime = Math.max(0, 3000 - elapsedTime); // Ensure 3 seconds minimum

      setTimeout(() => {
        document.getElementById('loader').style.display = 'none';
        document.body.classList.remove('processing');
      }, remainingTime);
    }
  </script>
</body>

</html>